<div class="app-grid">
  
  <aside class="col-left col-scrollable">
    <div class="card mini-profile-card mb-4" *ngIf="currentUser">
      
      <div class="user-avatar-large">
        {{ getInitials(currentUser.fullName) }}
      </div>
      
      <h5 class="fw-bold mb-1">{{ currentUser.fullName }}</h5>
      <p class="text-muted small mb-3">{{ currentUser.institution }}</p>
      
      <div class="mb-4 d-flex flex-wrap justify-content-center gap-1">
        <span *ngFor="let skill of currentUser.skills" class="mini-skill-tag">
          {{ skill.label }}
        </span>
        <span *ngIf="!currentUser.skills || currentUser.skills.length === 0" class="text-muted small fst-italic">
          Aucune compétence
        </span>
      </div>
      
      <div class="d-grid gap-2">
        <a routerLink="/profile" class="btn btn-outline-primary btn-sm rounded-pill">
          <i class="bi bi-person-gear me-1"></i> Mon Profil
        </a>
      </div>
    </div>
    
    <div class="card border-0 p-3" *ngIf="pendingRequests.length">
      <h6 class="fw-bold text-muted mb-3 small text-uppercase">
        <i class="bi bi-clock-history me-1"></i> En attente
      </h6>
      <div *ngFor="let req of pendingRequests" class="d-flex align-items-center justify-content-between mb-2 p-2 bg-white rounded shadow-sm">
        <div class="d-flex align-items-center">
          <div class="rounded-circle bg-warning text-white d-flex align-items-center justify-content-center me-2" style="width:30px;height:30px;font-size:0.8rem">
            {{ getInitials(req.requester.fullName) }}
          </div>
          <small class="fw-bold">{{ req.requester.fullName }}</small>
        </div>
        <button class="btn btn-sm btn-success rounded-circle" style="width:30px;height:30px;padding:0" (click)="acceptRequest(req.id)">
          <i class="bi bi-check"></i>
        </button>
      </div>
    </div>
  </aside>

  <main class="col-center col-scrollable px-2">
    
    <div class="create-post-card mb-4">
      <div class="d-flex mb-3">
        <div class="post-avatar me-3" *ngIf="currentUser">{{ getInitials(currentUser.fullName) }}</div>
        <div class="w-100">
          <input class="form-control fw-bold border-0 mb-2 px-0" style="font-size: 1.1rem;" placeholder="Un titre accrocheur..." [(ngModel)]="newPost.title">
          <textarea class="form-control create-post-input" rows="3" placeholder="Partagez vos recherches, questions ou découvertes..." [(ngModel)]="newPost.content"></textarea>
        </div>
      </div>
      
      <div class="d-flex justify-content-between align-items-center pt-2 border-top position-relative">
        
        <div class="d-flex align-items-center flex-grow-1 me-3">
          <i class="bi bi-tags-fill text-muted me-2"></i>
          
          <div class="position-relative">
            <input type="text" 
                   class="form-control form-control-sm border-0 bg-light rounded-pill px-3" 
                   style="width: 200px;"
                   placeholder="Ajouter un sujet..." 
                   [(ngModel)]="postSkillQuery"
                   (input)="onSearchPostSkill()">

            <div class="skills-dropdown" *ngIf="filteredPostSkills.length > 0">
              <div *ngFor="let skill of filteredPostSkills" 
                   class="skill-option d-flex justify-content-between"
                   (click)="selectPostSkill(skill)">
                <span>{{ skill.label }}</span>
                <i class="bi bi-plus text-primary"></i>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap ms-2">
             <span *ngFor="let sid of newPost.skillIds" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 rounded-pill me-1 d-flex align-items-center">
               {{ getSkillName(sid) }}
               <i class="bi bi-x ms-1 cursor-pointer" (click)="removeSkillFromPost(sid)"></i>
             </span>
          </div>
        </div>

        <button class="btn btn-primary rounded-pill px-4" (click)="publishPost()" [disabled]="!newPost.title || !newPost.content">
          Publier <i class="bi bi-send-fill ms-1"></i>
        </button>
      </div>
    </div>

    <div class="d-flex justify-content-center mb-4">
      <ul class="nav nav-pills card p-1 rounded-pill shadow-sm" style="flex-direction: row;">
          <li class="nav-item cursor-pointer">
          <a class="nav-link" [class.active]="viewMode === 'all'" (click)="switchView('all')">
            <i class="bi bi-clock me-1"></i> Récents
          </a>
        </li>
        <li class="nav-item cursor-pointer">
          <a class="nav-link" [class.active]="viewMode === 'recommended'" (click)="switchView('recommended')">
            <i class="bi bi-stars me-1"></i> Recommandés pour vous
          </a>
        </li>
        <li class="nav-item cursor-pointer">
          <a class="nav-link" [class.active]="viewMode === 'my-posts'" (click)="switchView('my-posts')">
            <i class="bi bi-person-badge me-1"></i> Mes Posts
          </a>
        </li>
      </ul>
    </div>

    <div *ngIf="posts.length === 0" class="text-center py-5 text-muted">
      <i class="bi bi-inbox fs-1"></i>
      <p class="mt-2">Aucun post à afficher pour le moment.</p>
    </div>

    <div *ngFor="let post of posts" class="card post-card">
      <div class="card-body">
        
        <div class="post-header justify-content-between align-items-start">
           <div class="d-flex align-items-center">
             <div class="post-avatar">
               {{ getInitials(post.author.fullName) }}
             </div>
             <div>
               <div class="fw-bold text-dark">
                 {{ post.author.fullName }}
                 <button *ngIf="canAddUser(post.author.id)" 
                         class="btn btn-sm btn-outline-primary py-0 px-2 ms-2 rounded-pill" 
                         style="font-size: 0.75rem;"
                         (click)="sendRequestToAuthor(post.author.id)"
                         title="Envoyer une invitation">
                   <i class="bi bi-person-plus-fill"></i> Suivre
                 </button>
               </div>
               <small class="text-muted">
                 {{ post.author.institution }} • {{ post.createdAt | date:'dd MMM à HH:mm' }}
                 <span *ngIf="post.updatedAt !== post.createdAt" class="fst-italic">(modifié)</span>
               </small>
             </div>
           </div>

           <div class="dropdown" *ngIf="currentUser && post.author.id === currentUser.id">
             <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
               <i class="bi bi-three-dots"></i>
             </button>
             <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
               <li>
                 <a class="dropdown-item cursor-pointer" (click)="startEditing(post)">
                   <i class="bi bi-pencil me-2"></i> Modifier
                 </a>
               </li>
             </ul>
           </div>
        </div>

        <div *ngIf="editingPostId !== post.id">
            <h5 class="fw-bold mb-2">{{ post.title }}</h5>
            <p class="text-secondary" style="line-height: 1.6;">{{ post.content }}</p>
            
            <div class="mb-3">
              <span *ngFor="let s of post.skills" class="skill-tag">
                #{{ s.label }}
              </span>
            </div>
        </div>

        <div *ngIf="editingPostId === post.id" class="bg-light p-3 rounded mb-3 animate__animated animate__fadeIn">
            <input type="text" class="form-control mb-2 fw-bold" [(ngModel)]="editFormData.title" placeholder="Titre">
            <textarea class="form-control mb-2" rows="3" [(ngModel)]="editFormData.content"></textarea>
            
            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-sm btn-outline-secondary" (click)="cancelEditing()">Annuler</button>
              <button class="btn btn-sm btn-success" (click)="saveEditedPost()">Enregistrer</button>
            </div>
         </div>

        <div class="border-top pt-3">
          <div *ngFor="let c of post.comments" class="comment-box d-flex">
             <strong class="me-2 text-nowrap">{{ c.author.fullName }} :</strong> 
             <span class="text-muted">{{ c.content }}</span>
          </div>
          
          <div class="d-flex mt-3 align-items-center">
             <div class="post-avatar" style="width:32px;height:32px;font-size:0.8rem;margin-right:8px" *ngIf="currentUser">
                {{ getInitials(currentUser.fullName) }}
             </div>
             <input class="form-control form-control-sm rounded-pill bg-light border-0 px-3" 
                    placeholder="Écrire un commentaire..." 
                    #cInput 
                    (keyup.enter)="postComment(post.id, cInput.value); cInput.value=''">
          </div>
        </div>

      </div>
    </div>
  </main>

  <aside class="col-right col-scrollable">
    
    <div class="card border-0 mb-3 shadow-sm overflow-visible">
      <div class="card-body p-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">
          <i class="bi bi-search me-1"></i> Trouver des collègues
        </h6>
        
        <div class="position-relative">
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" 
                   class="form-control bg-light border-start-0" 
                   placeholder="Tapez un nom..." 
                   [(ngModel)]="searchQuery"
                   (input)="onSearchInput(searchQuery)">
          </div>

          <div class="search-results-dropdown shadow" *ngIf="searchResults.length > 0">
            <div *ngFor="let user of searchResults" class="result-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-light text-primary d-flex justify-content-center align-items-center me-2 fw-bold" style="width:32px;height:32px;font-size:0.8rem">
                  {{ getInitials(user.fullName) }}
                </div>
                <div>
                  <div class="fw-bold small">{{ user.fullName }}</div>
                  <div class="text-muted" style="font-size: 0.7rem;">{{ user.institution }}</div>
                </div>
              </div>
              <button class="btn btn-sm btn-primary rounded-circle" (click)="sendFriendRequest(user.id)" title="Envoyer une invitation">
                <i class="bi bi-person-plus-fill"></i>
              </button>
            </div>
          </div>
          
          <div class="search-results-dropdown shadow p-3 text-center text-muted small" *ngIf="searchQuery.length > 1 && searchResults.length === 0">
            Aucun utilisateur trouvé.
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 mb-3 shadow-sm" *ngIf="sentRequests.length > 0">
      <div class="card-header bg-white border-0 pb-0 pt-3">
        <h6 class="fw-bold text-muted text-uppercase small text-primary">
          <i class="bi bi-send me-1"></i> En attente de réponse
        </h6>
      </div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center px-0" *ngFor="let req of sentRequests">
            <div class="d-flex align-items-center">
              <span class="small text-muted">{{ req.receiver.fullName }}</span>
            </div>
            <button class="btn btn-sm text-danger py-0" (click)="cancelRequest(req.id)" title="Annuler">
              <i class="bi bi-x-circle"></i> Annuler
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 pb-0 pt-3">
        <h6 class="fw-bold text-muted text-uppercase small">Mes Relations</h6>
      </div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center px-0" *ngFor="let f of friends">
            
            <div class="d-flex align-items-center cursor-pointer flex-grow-1" (click)="openChat(f.receiver)">
              <div class="position-relative">
                <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2 fw-bold" style="width:35px;height:35px;font-size:0.8rem">
                  {{ getInitials(f.receiver.fullName) }}
                </div>
                <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle" style="width:10px;height:10px;"></span>
              </div>
              <span class="small fw-bold">{{ f.receiver.fullName }}</span>
            </div>

            <div class="dropdown">
               <button class="btn btn-sm text-muted" type="button" data-bs-toggle="dropdown">
                 <i class="bi bi-three-dots-vertical"></i>
               </button>
               <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                 <li>
                   <a class="dropdown-item text-danger small cursor-pointer" (click)="removeFriend(f.receiver.id)">
                     <i class="bi bi-trash me-2"></i> Retirer des amis
                   </a>
                 </li>
               </ul>
            </div>

          </div>
          
          <div *ngIf="friends.length === 0" class="text-center text-muted small py-3">
            Pas encore d'amis. Utilisez la recherche ci-dessus !
          </div>
        </div>
      </div>
    </div>
  </aside>

</div>

<div class="chat-box-container animate__animated animate__slideInUp" *ngIf="selectedFriend">
  <div class="chat-header" (click)="selectedFriend = null">
    <div class="d-flex align-items-center">
      <i class="bi bi-chat-quote-fill me-2"></i>
      <span>{{ selectedFriend.fullName }}</span>
    </div>
    <i class="bi bi-x-lg cursor-pointer"></i>
  </div>
  
  <div class="chat-messages">
    <div *ngFor="let m of messages" class="d-flex w-100" [ngClass]="{'justify-content-end': m.sender.id === currentUser?.id}">
       <div class="msg-bubble shadow-sm" [ngClass]="m.sender.id === currentUser?.id ? 'msg-sent' : 'msg-received'">
         {{ m.content }}
       </div>
    </div>
  </div>
  
  <div class="p-2 bg-white border-top">
     <div class="input-group">
       <input class="form-control border-0 bg-light rounded-pill px-3" 
              [(ngModel)]="newMessage" 
              (keyup.enter)="sendMessage()" 
              placeholder="Votre message...">
       <button class="btn text-primary" (click)="sendMessage()">
         <i class="bi bi-send-fill"></i>
       </button>
     </div>
  </div>
</div>